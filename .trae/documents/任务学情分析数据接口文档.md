# 任务学情分析数据接口文档

## 1. 文档概述

本文档详细说明任务学情分析功能三个标签页的数据来源、获取方式和计算方法，为后端开发提供完整的对接参考。

### 1.1 功能模块
- **AI综合评价**：任务整体评价数据统计和分析
- **AI音频分析**：师范生音频数据的客观统计
- **AI视频分析**：师范生视频数据的客观统计

### 1.2 数据流向
```
个体学情分析数据 → 任务级聚合统计 → 前端展示
```

## 2. AI综合评价数据接口

### 2.1 数据结构定义

```typescript
interface TaskEvaluationData {
  averageScore: number          // 平均得分
  completionRate: number        // 完成进度
  excellentRate: number         // 优秀率（>=90分）
  passRate: number             // 及格率（>=60分）
  scoreDistribution: {         // 成绩分布
    range: string              // 分数段
    count: number              // 人数
    percentage: number         // 百分比
  }[]
  scoreStatistics: {           // 成绩统计指标
    maxScore: number           // 最高分
    minScore: number           // 最低分
    standardDeviation: number  // 标准差
    median: number             // 中位数
  }
  dimensionScores: {           // 六个维度得分
    name: string               // 维度名称
    averageScore: number       // 平均得分
    historicalAverage: number  // 历史平均
  }[]
  topStudents: {               // 前十名学生
    studentId: string
    studentName: string
    score: number
    avatar?: string
  }[]
  timeDistribution: {          // 课堂用时分布
    studentName: string
    duration: number           // 用时（分钟）
    rank: number              // 排名
  }[]
  timeStatistics: {            // 用时统计指标
    averageTime: number        // 平均用时
    maxTime: number            // 最长用时
    minTime: number            // 最短用时
    standardDeviation: number  // 标准差
  }
}
```

### 2.2 数据来源

| 字段 | 数据来源 | 说明 |
|------|----------|------|
| averageScore | student_evaluations表 | 所有学生总分的平均值 |
| completionRate | task_participants表 | 已完成人数/总参与人数 |
| excellentRate | student_evaluations表 | 总分>=90的学生比例 |
| passRate | student_evaluations表 | 总分>=60的学生比例 |
| scoreDistribution | student_evaluations表 | 按分数段统计人数分布 |
| scoreStatistics | student_evaluations表 | 成绩的统计指标（最高分、最低分、标准差、中位数） |
| dimensionScores | evaluation_dimensions表 | 六个维度的平均分 |
| topStudents | student_evaluations表 + users表 | 按总分排序取前10名 |
| timeDistribution | teaching_sessions表 | 每个学生的教学时长统计 |
| timeStatistics | teaching_sessions表 | 用时的统计指标（平均用时、最长用时、最短用时、标准差） |

### 2.3 计算逻辑

#### 2.3.1 平均得分计算
```sql
SELECT AVG(total_score) as averageScore 
FROM student_evaluations 
WHERE task_id = ? AND status = 'completed'
```

#### 2.3.2 完成进度计算
```sql
SELECT 
  (COUNT(CASE WHEN status = 'completed' THEN 1 END) * 100.0 / COUNT(*)) as completionRate
FROM task_participants 
WHERE task_id = ?
```

#### 2.3.3 优秀率计算
```sql
SELECT 
  (COUNT(CASE WHEN total_score >= 90 THEN 1 END) * 100.0 / COUNT(*)) as excellentRate
FROM student_evaluations 
WHERE task_id = ? AND status = 'completed'
```

#### 2.3.4 成绩分布计算
```sql
SELECT 
  CASE 
    WHEN total_score >= 90 THEN '90-100'
    WHEN total_score >= 80 THEN '80-89'
    WHEN total_score >= 70 THEN '70-79'
    WHEN total_score >= 60 THEN '60-69'
    ELSE '0-59'
  END as range,
  COUNT(*) as count,
  (COUNT(*) * 100.0 / (SELECT COUNT(*) FROM student_evaluations WHERE task_id = ?)) as percentage
FROM student_evaluations 
WHERE task_id = ? AND status = 'completed'
GROUP BY range
```

#### 2.3.5 成绩统计指标计算

**最高分和最低分：**
```sql
SELECT 
  MAX(total_score) as maxScore,
  MIN(total_score) as minScore
FROM student_evaluations 
WHERE task_id = ? AND status = 'completed'
```

**标准差计算：**
```sql
SELECT 
  STDDEV(total_score) as standardDeviation
FROM student_evaluations 
WHERE task_id = ? AND status = 'completed'
```

**中位数计算：**
```sql
-- MySQL 8.0+ 使用窗口函数
WITH ranked_scores AS (
  SELECT 
    total_score,
    ROW_NUMBER() OVER (ORDER BY total_score) as row_num,
    COUNT(*) OVER () as total_count
  FROM student_evaluations 
  WHERE task_id = ? AND status = 'completed'
)
SELECT 
  AVG(total_score) as median
FROM ranked_scores 
WHERE row_num IN (
  FLOOR((total_count + 1) / 2),
  CEIL((total_count + 1) / 2)
)
```

#### 2.3.6 课堂用时统计指标计算

**用时统计：**
```sql
SELECT 
  AVG(duration_minutes) as averageTime,
  MAX(duration_minutes) as maxTime,
  MIN(duration_minutes) as minTime,
  STDDEV(duration_minutes) as standardDeviation
FROM teaching_sessions ts
JOIN task_participants tp ON ts.participant_id = tp.id
WHERE tp.task_id = ? AND ts.status = 'completed'
```

#### 2.3.7 维度得分计算
```sql
SELECT 
  d.dimension_name as name,
  AVG(ed.score) as averageScore,
  (SELECT AVG(score) FROM evaluation_dimensions WHERE dimension_name = d.dimension_name) as historicalAverage
FROM evaluation_dimensions ed
JOIN dimensions d ON ed.dimension_id = d.id
JOIN student_evaluations se ON ed.evaluation_id = se.id
WHERE se.task_id = ? AND se.status = 'completed'
GROUP BY d.dimension_name
```

### 2.4 API接口设计

```
GET /api/tasks/{taskId}/evaluation-data
```

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "averageScore": 85.2,
    "completionRate": 87.5,
    "excellentRate": 34.4,
    "passRate": 87.5,
    "scoreDistribution": [
      {"range": "90-100", "count": 11, "percentage": 34.4},
      {"range": "80-89", "count": 9, "percentage": 28.1}
    ],
    "scoreStatistics": {
      "maxScore": 96.5,
      "minScore": 58.2,
      "standardDeviation": 12.8,
      "median": 84.5
    },
    "dimensionScores": [
      {"name": "教学设计", "averageScore": 88.5, "historicalAverage": 82.3}
    ],
    "topStudents": [
      {"studentId": "2021001", "studentName": "李明轩", "score": 96.5}
    ],
    "timeDistribution": [
      {"studentName": "李明轩", "duration": 45.2, "rank": 1}
    ],
    "timeStatistics": {
      "averageTime": 35.9,
      "maxTime": 45.2,
      "minTime": 28.3,
      "standardDeviation": 4.8
    }
  }
}
```

## 3. AI音频分析数据接口

### 3.1 数据结构定义

```typescript
interface TaskAudioData {
  mandarinStats: {             // 普通话统计
    excellent: number          // 优秀人数
    good: number              // 良好人数
    average: number           // 一般人数
    poor: number              // 较差人数
  }
  speedStats: {               // 语速统计
    averageSpeed: number      // 平均语速
    minSpeed: number          // 最低语速
    maxSpeed: number          // 最高语速
    distribution: { range: string, count: number }[]
  }
  volumeStats: {              // 音量统计
    averageVolume: number
    distribution: { range: string, count: number }[]
  }
  keywordStats: {             // 关键词统计
    totalKeywords: number
    averagePerStudent: number
    topKeywords: { word: string, frequency: number, students: string[] }[]
  }
  fillerStats: {              // 口头禅统计
    totalFillers: number
    averagePerStudent: number
    commonFillers: { filler: string, frequency: number, students: string[] }[]
  }
  questionStats: {            // 提问统计
    totalQuestions: number
    averagePerStudent: number
    questionTypes: { type: string, count: number }[]
  }
}
```

### 3.2 数据来源

| 字段 | 数据来源 | 说明 |
|------|----------|------|
| mandarinStats | audio_analysis表 | 普通话水平评级统计 |
| speedStats | audio_analysis表 | 语速数据统计 |
| volumeStats | audio_analysis表 | 音量数据统计 |
| keywordStats | audio_keywords表 | 关键词使用统计 |
| fillerStats | audio_fillers表 | 口头禅使用统计 |
| questionStats | audio_questions表 | 提问类型统计 |

### 3.3 计算逻辑

#### 3.3.1 普通话水平统计
```sql
SELECT 
  COUNT(CASE WHEN mandarin_level = 'excellent' THEN 1 END) as excellent,
  COUNT(CASE WHEN mandarin_level = 'good' THEN 1 END) as good,
  COUNT(CASE WHEN mandarin_level = 'average' THEN 1 END) as average,
  COUNT(CASE WHEN mandarin_level = 'poor' THEN 1 END) as poor
FROM audio_analysis aa
JOIN student_evaluations se ON aa.evaluation_id = se.id
WHERE se.task_id = ?
```

#### 3.3.2 语速统计
```sql
SELECT 
  AVG(speech_speed) as averageSpeed,
  MIN(speech_speed) as minSpeed,
  MAX(speech_speed) as maxSpeed
FROM audio_analysis aa
JOIN student_evaluations se ON aa.evaluation_id = se.id
WHERE se.task_id = ?
```

#### 3.3.3 关键词统计
```sql
SELECT 
  ak.keyword as word,
  COUNT(*) as frequency,
  GROUP_CONCAT(u.name) as students
FROM audio_keywords ak
JOIN student_evaluations se ON ak.evaluation_id = se.id
JOIN users u ON se.student_id = u.id
WHERE se.task_id = ?
GROUP BY ak.keyword
ORDER BY frequency DESC
LIMIT 10
```

### 3.4 API接口设计

```
GET /api/tasks/{taskId}/audio-data
```

## 4. AI视频分析数据接口

### 4.1 数据结构定义

```typescript
interface TaskVideoData {
  postureStats: {             // 姿态统计
    stability: { excellent: number, good: number, average: number, poor: number }
    gesture: { excellent: number, good: number, average: number, poor: number }
    orientation: { excellent: number, good: number, average: number, poor: number }
    movement: { excellent: number, good: number, average: number, poor: number }
  }
  expressionStats: {          // 表情统计
    happy: number             // 愉悦表情占比
    confident: number         // 自信表情占比
    focused: number           // 专注表情占比
    neutral: number           // 平静表情占比
    concerned: number         // 担忧表情占比
  }
  blackboardStats: {          // 板书统计
    clarity: { excellent: number, good: number, average: number, poor: number }
    layout: { excellent: number, good: number, average: number, poor: number }
    colorUsage: { single: number, multiple: number }
  }
  interactionStats: {         // 互动统计
    averageQuestions: number     // 平均提问次数
    averageEyeContact: number    // 平均眼神交流时间
    averageResponses: number     // 平均学生回应次数
    averageParticipation: number // 平均参与度
  }
}
```

### 4.2 数据来源

| 字段 | 数据来源 | 说明 |
|------|----------|------|
| postureStats | video_posture表 | 教学姿态评级统计 |
| expressionStats | video_expression表 | 面部表情时长占比 |
| blackboardStats | video_blackboard表 | 板书质量评级统计 |
| interactionStats | video_interaction表 | 课堂互动数据统计 |

### 4.3 计算逻辑

#### 4.3.1 姿态统计
```sql
SELECT 
  posture_type,
  COUNT(CASE WHEN rating = 'excellent' THEN 1 END) as excellent,
  COUNT(CASE WHEN rating = 'good' THEN 1 END) as good,
  COUNT(CASE WHEN rating = 'average' THEN 1 END) as average,
  COUNT(CASE WHEN rating = 'poor' THEN 1 END) as poor
FROM video_posture vp
JOIN student_evaluations se ON vp.evaluation_id = se.id
WHERE se.task_id = ?
GROUP BY posture_type
```

#### 4.3.2 表情统计
```sql
SELECT 
  expression_type,
  AVG(duration_percentage) as percentage
FROM video_expression ve
JOIN student_evaluations se ON ve.evaluation_id = se.id
WHERE se.task_id = ?
GROUP BY expression_type
```

### 4.4 API接口设计

```
GET /api/tasks/{taskId}/video-data
```

## 5. 数据聚合策略

### 5.1 实时计算 vs 预计算

**实时计算**（推荐）：
- 适用于数据量较小的情况
- 保证数据实时性
- 查询时动态聚合

**预计算**：
- 适用于大数据量场景
- 定时任务更新聚合数据
- 存储在task_statistics表中

### 5.2 缓存策略

```javascript
// Redis缓存键设计
const cacheKey = `task_analysis:${taskId}:${type}` // type: evaluation|audio|video
const cacheTTL = 300 // 5分钟过期
```

### 5.3 数据更新触发

- 学生提交评价时触发缓存清理
- 管理员修改评价时触发重新计算
- 定时任务每小时更新一次

## 6. 错误处理

### 6.1 数据缺失处理

```javascript
// 前端默认值处理
const defaultEvaluationData = {
  averageScore: 0,
  completionRate: 0,
  excellentRate: 0,
  passRate: 0,
  scoreDistribution: [],
  dimensionScores: [],
  topStudents: [],
  timeDistribution: []
}
```

### 6.2 异常情况

- 任务不存在：返回404
- 无权限访问：返回403
- 数据计算异常：返回500，记录错误日志
- 部分数据缺失：返回部分数据，标记缺失字段

## 7. 性能优化建议

### 7.1 数据库优化

```sql
-- 添加必要索引
CREATE INDEX idx_student_evaluations_task_id ON student_evaluations(task_id);
CREATE INDEX idx_audio_analysis_evaluation_id ON audio_analysis(evaluation_id);
CREATE INDEX idx_video_analysis_evaluation_id ON video_analysis(evaluation_id);
```

### 7.2 查询优化

- 使用JOIN减少查询次数
- 合理使用子查询和CTE
- 避免N+1查询问题

### 7.3 接口优化

- 支持分页查询大数据量
- 提供数据压缩选项
- 实现增量更新机制

## 8. 部署说明

### 8.1 环境要求

- Node.js >= 16.0
- MySQL >= 8.0
- Redis >= 6.0

### 8.2 配置示例

```javascript
// config/database.js
module.exports = {
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  pool: {
    max: 10,
    min: 0,
    acquire: 30000,
    idle: 10000
  }
}
```

## 9. 测试用例

### 9.1 单元测试

```javascript
// 测试平均分计算
test('calculate average score', async () => {
  const result = await calculateAverageScore('task_123')
  expect(result).toBeCloseTo(85.2, 1)
})
```

### 9.2 集成测试

```javascript
// 测试API接口
test('GET /api/tasks/:taskId/evaluation-data', async () => {
  const response = await request(app)
    .get('/api/tasks/123/evaluation-data')
    .expect(200)
  
  expect(response.body.data).toHaveProperty('averageScore')
  expect(response.body.data).toHaveProperty('completionRate')
})
```

## 10. 版本更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0.0 | 2025-01-20 | 初始版本，包含三个模块的完整接口定义 |
| 1.1.0 | 2025-01-21 | 添加课堂用时分布数据 |
| 1.2.0 | 2025-01-22 | 优化数据聚合策略和缓存机制 |

---

**联系方式**：如有疑问请联系前端开发团队
**文档维护**：请及时更新接口变更